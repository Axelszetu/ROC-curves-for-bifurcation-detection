---
title: "R Notebook"
output: html_notebook
---
```{r}
library(BSDA)
```


#ROC-curves for bifurcation detection
The purpose of this notebook is to
1) Develop a scheme for simulating the dynamics of a double-well potential with additive(for now) noise.
2) Compute hypothesis tests only using data from a restricted time interval.
3) Compute (and plot) ROC curves for different significance threshholds, control parameter speed, observation frequency and variance.

## Simulation of paths
```{r}
make_path <- function(x0, beta4 = 1, beta2 = 1, sigma = 1, tmax = 2, deltat = 0.01, lambda0 = 0.5, lambda_end){
  t <- seq(from = 0, to = tmax, by = deltat)
  x <- numeric(length = length(t))
  x[1] <- x0
  dW <- rnorm(n = length(t) - 1)
  lambda <- seq(from = lambda0, to = lambda_end, along.with = t)
  drift <- function(x, lambda){
    -beta4*x^3 + beta2*x + lambda
  }
  for (i in (2:length(t))){
    x[i] <- x[i-1] + drift(x = x[i-1], lambda = lambda[i-1])*deltat + dW[i]*sqrt(deltat)*sigma
  }
  data.frame(t,x)
}
```
We test that the function works:
```{r}
test_path <- make_path(x0 = 1, sigma = 0.05, tmax = 10, deltat = 0.01, lambda0 = 0, lambda_end = -1)
plot(test_path$x)
```
It is worth noting that even with relatively strong parameter movement over the time period, we are not guaranteed to cross the 0 point.
This also depends on the noise.
It is also worth noting that the equilibrium value of x at the time of bifurcation is 0.6, so we would not necessarily expect to have crossed 0 by the end of the simulation.
Increasing the time of running also gives the process time to "settle in" to its new equilibrium.
It might be interesting to make a plot of a number of simulated paths over different parameters.
We desire a controlled experiment where we know the exact time of bifurcation.
Thus, we need to do some setup computation to establish the critical value of the control parameter.
By considering the derivative of the drift we find that it has two roots.
Superimposing the drift with the derivative of the drift shows that the larger root of the derivative is the value of x where the saddle-node bifurcation occurs. We can evaluate $F(x,\lambda)$ in $x = \frac{1}{sqrt{3}}$ and solve the resulting equation for lambda.
In the case where $\beta_4 = \beta_2 = 1$, we get $\lambda_c = \frac{2}{3 sqrt{3}}$.
Since we now have a procedure for finding the bifurcation points, we can in principle automate the scaling of dlambda such that bifurcation always occurs at the end of the simulation. In that case we need to make sure that the initial value of lambda is a pre-bifurcation state.
I suppose the easiest way to implement linear movement of the control parameter towards the critical value is through the seq function.
This also easily lets us introduce an equilibrium period at the start if we so desire.

##Estimation and hypothesis testing
```{r}
hypothesis_tester <- function(data, beta4 = 1, beta2 = 1, significance = 0.95){
  x <- data$x
  t <- data$t
  deltat <- t[2] - t[1]
  drift <- function(x){
    -beta4*x^3 + beta2*x
  }
  x_predicted <- numeric(length = length(x))
  x_predicted[1] <- x[1]
  for (i in (2:length(x_predicted))){
    x_predicted[i] <- x[i-1] + drift(x[i-1])*deltat
  }
  residuals <- (x-x_predicted)[2:length(x)]
  residuals
}
```
We test that the function works:
```{r}
test_path <- make_path(x0 = 1, sigma = 0.05, tmax = 10, deltat = 0.01, lambda0 = 0, lambda_end = -1)
residuals <- hypothesis_tester(data = test_path)
plot(residuals)
```


